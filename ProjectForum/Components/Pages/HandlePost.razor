@page "/handlepost"
@using ProjectForum.Data 
@using ProjectForum.Models 
@using Microsoft.AspNetCore.Identity 
@using Microsoft.AspNetCore.Authorization 
@rendermode InteractiveServer 
@inject PostService PostService 
@inject UserManager<ApplicationUser> UserManager 
@inject AuthenticationStateProvider AuthenticationStateProvider 
@inject NavigationManager Navigation


<PageTitle>(PostId.HasValue ? "Edit Post" : "Create Post")</PageTitle>


@code {
    public int PostId { get; set; }
    private Post post = new Post();
    private bool isAdmin;

    protected override async Task OnInitializedAsync()
    {
        var user = await AuthenticationStateProvider.GetAuthenticationStateAsync().User;
        isAdmin = user.IsInRole("Admin"); 

        if (PostId.HasValue)
        {
            post = await GetPostById(PostId.Value);
            if (!isAdmin && post.UserId != user?.Identity?.Name)
            {
                Navigation.NavigateTo ("/forum"); // tillbaka till startsidan 
            }
        }
    }

    private async Task HandlePostSubmit()
    {
        if (PostId.HasValue)
        {
            await PostService.UpdatePost(post);
        }
        else
        {
            await PostService.CreatePost(post);
        }

        Navigation.NavigateTo("/forum"); // tillbaka till startsidan 
    }

    private async Task DeletePost()
    {
        if (isAdmin || post.UserId == await AuthenticationStateProvider.GetAuthenticationStateAsync().User?.Identity?.Name)
        {
            await PostService.DeletePost(post.Id);
            Navigation.NavigateTo("/forum");
        }
    }
}